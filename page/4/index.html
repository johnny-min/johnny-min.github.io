<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-docker安装和使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/26/docker%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2020-08-26T06:08:02.000Z" itemprop="datePublished">2020-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/26/docker%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/">docker安装和使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装-docker"><a href="#安装-docker" class="headerlink" title="安装 docker"></a>安装 docker</h2><p>ubuntu:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 卸载旧版本</span><br><span class="line">sudo apt-get remove docker \</span><br><span class="line">               docker-engine \</span><br><span class="line">               docker.io</span><br><span class="line"># 更新 apt 软件包缓存，并安装 docker-ce</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
<p>centos</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 卸载旧版本</span><br><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-selinux \</span><br><span class="line">                  docker-engine-selinux \</span><br><span class="line">                  docker-engine</span><br><span class="line"># 安装依赖</span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line"># 添加 yum 软件源</span><br><span class="line"></span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">  --add-repo \</span><br><span class="line">  https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line"></span><br><span class="line">sudo sed -i &#39;s&#x2F;download.docker.com&#x2F;mirrors.ustc.edu.cn\&#x2F;docker-ce&#x2F;g&#39; &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 官方源</span><br><span class="line">#  sudo yum-config-manager \</span><br><span class="line">#    --add-repo \</span><br><span class="line">#    https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line"></span><br><span class="line"># 安装 Docker</span><br><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
<h2 id="启动-docker"><a href="#启动-docker" class="headerlink" title="启动 docker"></a>启动 docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br><span class="line"># 启动</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"># 状态</span><br><span class="line">service docker status</span><br><span class="line"># 结束</span><br><span class="line">sudo systemctl stop docker</span><br><span class="line"># 版本</span><br><span class="line">docker -v</span><br></pre></td></tr></table></figure>
<h2 id="建立-docker-用户组"><a href="#建立-docker-用户组" class="headerlink" title="建立 docker 用户组"></a>建立 docker 用户组</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure>
<h2 id="镜像操作"><a href="#镜像操作" class="headerlink" title="镜像操作"></a>镜像操作</h2><p>获取镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull [选项] [Docker Registry 地址[:端口号]&#x2F;]仓库名[:标签]</span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it ubuntu:18.04 bash</span><br></pre></td></tr></table></figure>
<p>列出已下载镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker image ls</span><br></pre></td></tr></table></figure>
<p>删除镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image rm ubuntu</span><br></pre></td></tr></table></figure>
<p>例子<br>定制 web server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run --name webserver -d -p 1234:80 nginx</span><br></pre></td></tr></table></figure>
<p>停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop webserver</span><br></pre></td></tr></table></figure>
<p>删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker rm webserver</span><br></pre></td></tr></table></figure>
<p>定制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cheng@cheng-PC:~&#x2F;Desktop$ sudo docker exec -it webserver bash</span><br><span class="line">root@d664a813b0f3:&#x2F;# echo &#39;&lt;h1&gt;Hello, Docker!&lt;&#x2F;h1&gt;&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br><span class="line">root@d664a813b0f3:&#x2F;# exit</span><br></pre></td></tr></table></figure>
<p>查看改动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cheng@cheng-PC:~&#x2F;Desktop$ sudo docker diff webserver</span><br><span class="line">C &#x2F;etc</span><br><span class="line">C &#x2F;etc&#x2F;nginx</span><br><span class="line">C &#x2F;etc&#x2F;nginx&#x2F;conf.d</span><br><span class="line">C &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</span><br><span class="line">C &#x2F;var</span><br><span class="line">C &#x2F;var&#x2F;cache</span><br><span class="line">C &#x2F;var&#x2F;cache&#x2F;nginx</span><br><span class="line">A &#x2F;var&#x2F;cache&#x2F;nginx&#x2F;scgi_temp</span><br><span class="line">A &#x2F;var&#x2F;cache&#x2F;nginx&#x2F;uwsgi_temp</span><br><span class="line">A &#x2F;var&#x2F;cache&#x2F;nginx&#x2F;client_temp</span><br><span class="line">A &#x2F;var&#x2F;cache&#x2F;nginx&#x2F;fastcgi_temp</span><br><span class="line">A &#x2F;var&#x2F;cache&#x2F;nginx&#x2F;proxy_temp</span><br><span class="line">C &#x2F;run</span><br><span class="line">A &#x2F;run&#x2F;nginx.pid</span><br><span class="line">C &#x2F;root</span><br><span class="line">A &#x2F;root&#x2F;.bash_history</span><br><span class="line">C &#x2F;usr</span><br><span class="line">C &#x2F;usr&#x2F;share</span><br><span class="line">C &#x2F;usr&#x2F;share&#x2F;nginx</span><br><span class="line">C &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line">C &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>
<p>提交修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo docker commit --author &quot;cm&quot; --message &quot;修改了默认界面&quot; webserver nginx:v2</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker image ls nginx</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">nginx               v2                  c18429eb9ac1        About a minute ago   133MB</span><br><span class="line">nginx               latest              f35646e83998        8 days ago           133MB</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker run --name web2 -d -p 1235:80 nginx:v2</span><br><span class="line">098a45f04be8f7da8241093963c63739b1be7e0dba3c390b20ddd0d935e5c5c6</span><br></pre></td></tr></table></figure>
<h2 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a>容器操作</h2><p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-t 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上， -i 则让容器的标准输入保持打开</span><br><span class="line">docker run -t -i centos:7 &#x2F;bin&#x2F;bash</span><br></pre></td></tr></table></figure>
<p>启动已终止容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker container start [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line">docker container restart # 重启</span><br></pre></td></tr></table></figure>
<p>守护态运行(-d)<br>容器会在后台运行并不会把输出的结果 (STDOUT) 打印到宿主机上面(输出结果可以用 docker logs 查看)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d ubuntu:18.04 &#x2F;bin&#x2F;sh -c &quot;while true; do echo hello world; sleep 1; done&quot;</span><br></pre></td></tr></table></figure>
<p>docker container ls 查看容器信息<br>docker container logs 获取容器的输出信息<br>终止<br>docker container stop</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container stop d446</span><br><span class="line">d446</span><br></pre></td></tr></table></figure>
<p>终止状态的容器可以用 docker container ls -a 命令看到<br>进入容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 使用-d,-i,-t启动容器</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker run -dit centos:7</span><br><span class="line">d446e2353e022dd67bc0e7443f978c35fdcb40613ac2a7c2062fe6fb7b1f8383</span><br><span class="line"># 查看容器信息</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">d446e2353e02        centos:7            &quot;&#x2F;bin&#x2F;bash&quot;         14 seconds ago      Up 13 seconds                           brave_wilson</span><br><span class="line"># 进入容器熟悉的命令行模式</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker exec -it d446 bash</span><br><span class="line">[root@d446e2353e02 &#x2F;]# ^C</span><br><span class="line"># 使用docker exec命令进入容器后使用exit不会停止容器</span><br><span class="line">[root@d446e2353e02 &#x2F;]# exit</span><br><span class="line">exit</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">d446e2353e02        centos:7            &quot;&#x2F;bin&#x2F;bash&quot;         6 minutes ago       Up 6 minutes                            brave_wilson</span><br></pre></td></tr></table></figure>
<p>导出容器<br>docker export</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                       PORTS               NAMES</span><br><span class="line">d446e2353e02        centos:7            &quot;&#x2F;bin&#x2F;bash&quot;         13 minutes ago      Exited (137) 4 minutes ago                       brave_wilson</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker export d446e2353e02 &gt; centos.tar</span><br></pre></td></tr></table></figure>
<p>导入<br>docker import</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# cat centos.tar | docker import - test&#x2F;centos:v1.0</span><br><span class="line">sha256:f78f33be371871c1ea60ca4695b1e271d081929d44c7d8643a9968949ea05fae</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test&#x2F;centos         v1.0                f78f33be3718        45 seconds ago      203MB</span><br><span class="line">nginx               latest              f35646e83998        8 days ago          133MB</span><br><span class="line">centos              7                   7e6257c9f8d8        2 months ago        203MB</span><br></pre></td></tr></table></figure>
<p>指定url导入<br>docker import <a href="http://example.com/exampleimage.tgz" target="_blank" rel="noopener">http://example.com/exampleimage.tgz</a> example/imagerepo<br>删除容器<br>docker container rm </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                  NAMES</span><br><span class="line">d446e2353e02        centos:7            &quot;&#x2F;bin&#x2F;bash&quot;              13 minutes ago      Exited (137) 3 minutes ago                           brave_wilson</span><br><span class="line">098a45f04be8        nginx:v2            &quot;&#x2F;docker-entrypoint.…&quot;   16 hours ago        Created                                              web2</span><br><span class="line">d664a813b0f3        nginx               &quot;&#x2F;docker-entrypoint.…&quot;   16 hours ago        Exited (255) 43 minutes ago   0.0.0.0:1234-&gt;80&#x2F;tcp   webserver</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container rm web2</span><br><span class="line">web2</span><br></pre></td></tr></table></figure>
<p>清理所有处于终止状态的容器<br>docker container prune</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container ls -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                        PORTS               NAMES</span><br><span class="line">d446e2353e02        centos:7            &quot;&#x2F;bin&#x2F;bash&quot;         21 minutes ago      Exited (137) 11 minutes ago                       brave_wilson</span><br><span class="line">root@cheng-PC:&#x2F;home&#x2F;cheng&#x2F;Desktop# docker container prune</span><br><span class="line">WARNING! This will remove all stopped containers.</span><br><span class="line">Are you sure you want to continue? [y&#x2F;N] y</span><br><span class="line">Deleted Containers:</span><br><span class="line">d446e2353e022dd67bc0e7443f978c35fdcb40613ac2a7c2062fe6fb7b1f8383</span><br><span class="line"></span><br><span class="line">Total reclaimed space: 5B</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/26/docker%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/" data-id="ckee117ik00009suj647e70rz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-flask请求上下文和应用上下文" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/26/flask%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/" class="article-date">
  <time datetime="2020-08-26T02:15:53.000Z" itemprop="datePublished">2020-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/26/flask%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/">flask请求上下文和应用上下文</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="上下文"><a href="#上下文" class="headerlink" title="上下文"></a>上下文</h2><p>在程序中，上下文是指一个个外部变量值的集合</p>
<h2 id="应用上下文"><a href="#应用上下文" class="headerlink" title="应用上下文"></a>应用上下文</h2><p>在请求，CLI命令或其他活动期间，应用程序上下文跟踪应用程序级别的数据。而不是将应用程序传递给每个函数，而是访问current_app和 g代理</p>
<h2 id="请求上下文"><a href="#请求上下文" class="headerlink" title="请求上下文"></a>请求上下文</h2><p>flask从客户端接受请求时，视图函数如果要处理请的的话，需要访问一些对象，这些对象可能是作为参数传递过来的，也可能是外部变量（如request）。这些个外部变量有特定值才有意义，即上下文。<br>request就是一个请求上下文，当请求被推送后，request才有意义，才可以使用。</p>
<h2 id="引申"><a href="#引申" class="headerlink" title="引申"></a>引申</h2><p>请求上下文：request(记录http请求的相关内容)、session(记录请求会话中的信息)。<br>应用上下文：g(在同一次请求上下文中设置临时变量属性，供请求上下文使用)、curent_app(保存当前app相关信息)。</p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p>通常情况下应用上下文和请求上下文具有相同的生命周期。<br>即：当flask应用开始处理请求时，它将推送应用上下文和请求上下文。当请求结束时，将弹出请求上下文，然后弹出应用上下文。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/26/flask%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8C%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87/" data-id="ckee117jg00019suj0pvm1qwb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/" rel="tag">flask</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-get和post" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/19/get%E5%92%8Cpost/" class="article-date">
  <time datetime="2020-08-19T10:30:59.000Z" itemprop="datePublished">2020-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/19/get%E5%92%8Cpost/">get和post</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="get-or-post"><a href="#get-or-post" class="headerlink" title="get or post"></a>get or post</h2><p>一下仅为个人理解：<br>1.一般情况下获取数据用get,修改和更新数据用post。<br>2.get的参数是在url中的，而post参数是在body中携带的。<br>3.get获取的数据一般是在2KB以内，而post则可以超过2KB。<br>4.URL太长了不好看。<br>5.安全性来讲post可能会安全一点，但也到不了哪去。<br>6.效率上讲get高效一点。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/19/get%E5%92%8Cpost/" data-id="cke3ywnui0000l4ujbl9e3s1m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-git" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/19/git/" class="article-date">
  <time datetime="2020-08-19T03:53:18.000Z" itemprop="datePublished">2020-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/19/git/">git</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="下载git"><a href="#下载git" class="headerlink" title="下载git"></a>下载git</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install git</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git-all</span><br></pre></td></tr></table></figure>
<h2 id="配置git"><a href="#配置git" class="headerlink" title="配置git"></a>配置git</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;Your Name&quot;</span><br><span class="line">git config --global user.email &quot;123@email.com&quot;</span><br><span class="line">git config --list</span><br></pre></td></tr></table></figure>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>去github上NEW一个Repositories，输入Repository name，其他的默认就行。然后Create repository</p>
<h2 id="第一次提交"><a href="#第一次提交" class="headerlink" title="第一次提交"></a>第一次提交</h2><p>1、打开cmd，进入项目目录下<br>2、git init<br>3、git add .<br>4、git status<br>5、git commit -m “first commit”<br>6、git remote add origin <a href="mailto:git@github.com">git@github.com</a>:johnny-min/Flask_restful_skeleton.git<br>7、git pull –rebase origin master<br>8、git push -u origin master</p>
<h2 id="二次提交"><a href="#二次提交" class="headerlink" title="二次提交"></a>二次提交</h2><p>1.git status 查看项目中哪些文件发生了变化，当做验证使用<br>2.git add . 将所有变更文件添加进来<br>3.git status 这个时候文件都变成了 new file<br>4.git commit -am “second commit”<br>5.git push origin master 把本地的推送到远程的分支上面即可<br>6.git status 查看</p>
<h2 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone *****</span><br></pre></td></tr></table></figure>
<h2 id="查看仓库"><a href="#查看仓库" class="headerlink" title="查看仓库"></a>查看仓库</h2><p>git status<br>git log –oneline</p>
<h2 id="换账号换仓库"><a href="#换账号换仓库" class="headerlink" title="换账号换仓库"></a>换账号换仓库</h2><p>git config user.name # 查看当前用户名<br>git config user.email # 查看当前邮件<br>git config –global user.name “Your Name”<br>git config –global user.email “<a href="mailto:123@email.com">123@email.com</a>“<br>git remote set-url origin [url]<br>git remote rm origin  # 删除<br>git remote add origin <a href="mailto:git@github.com">git@github.com</a>:johnny-min/Flask_restful_skeleton.git # 添加</p>
<h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git branch &lt;分支名&gt;    # 创建分支</span><br><span class="line">git checkout 分支名    # 切换分支</span><br><span class="line">git push origin 分支名 # 推送到远程</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/19/git/" data-id="cke3ywnvn0001l4uj6i5ocwan" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-并发和并行" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/14/%E5%B9%B6%E5%8F%91%E5%92%8C%E5%B9%B6%E8%A1%8C/" class="article-date">
  <time datetime="2020-08-14T03:09:23.000Z" itemprop="datePublished">2020-08-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/14/%E5%B9%B6%E5%8F%91%E5%92%8C%E5%B9%B6%E8%A1%8C/">并发和并行</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>并发的关键是你有处理多个任务的能力，不一定要同时。<br>并行的关键是你有同时处理多个任务的能力。</p>
<p>所以它们最关键的点就是：是否是 同时。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/14/%E5%B9%B6%E5%8F%91%E5%92%8C%E5%B9%B6%E8%A1%8C/" data-id="ckdtu680p0000goujcii3besa" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B9%B6%E8%A1%8C/" rel="tag">并行</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql索引" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/14/mysql%E7%B4%A2%E5%BC%95/" class="article-date">
  <time datetime="2020-08-14T02:17:32.000Z" itemprop="datePublished">2020-08-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/14/mysql%E7%B4%A2%E5%BC%95/">mysql索引</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="索引定义"><a href="#索引定义" class="headerlink" title="索引定义"></a>索引定义</h2><p>mysql索引的官方定义是帮助mysql高效获取数据的数据结构，索引可以大大提高MySQL的检索速度。</p>
<h2 id="索引文件"><a href="#索引文件" class="headerlink" title="索引文件"></a>索引文件</h2><p>定义了索引后，会生成索引文件，它保存了数据操作的地址。<br>MyISAM引擎:<br>.myd 即 my data, 表数据文件<br>.myi 即 my index, 索引文件<br>InnoDB引擎：（采用表空间来管理数据，存储表数据和索引）<br>InnoDB数据库文件： ibdata1、ibdata2等：系统表空间文件，存储InnoDB系统信息和用户数据库表数据和索引，所有表共用。<br>.ibd文件：单表表空间文件，每个表使用一个表空间文件（file per table），存放用户数据库表数据和索引。<br>日志文件：ib_logfile1、ib_logfile2</p>
<h2 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h2><p>打个比方：在一个班级里，老师要找小明，如果一个一个找会很慢，怎么办呢？老师可以通过找小明所在的列。<br>老师记住每名学生的位置占用了其大脑的空间，这样每来一名新同学老师都要记住位置，或者离开一名同学就要删除该同学的位置。所以索引会影响数据的更新速度。</p>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>select * from game_two_player for update; # 互斥锁、排他锁<br>select * from game_two_player LOCK IN SHARE MODE; # 共享锁 可以一起读取，但不能修改</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/14/mysql%E7%B4%A2%E5%BC%95/" data-id="ckdtu68170001gouj8ijvfzr9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-解决go依赖包被墙" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/12/%E8%A7%A3%E5%86%B3go%E4%BE%9D%E8%B5%96%E5%8C%85%E8%A2%AB%E5%A2%99/" class="article-date">
  <time datetime="2020-08-12T05:13:39.000Z" itemprop="datePublished">2020-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/12/%E8%A7%A3%E5%86%B3go%E4%BE%9D%E8%B5%96%E5%8C%85%E8%A2%AB%E5%A2%99/">解决go依赖包被墙</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="最省事的方法设置GO111MODULE和GOPROXY"><a href="#最省事的方法设置GO111MODULE和GOPROXY" class="headerlink" title="最省事的方法设置GO111MODULE和GOPROXY"></a>最省事的方法设置GO111MODULE和GOPROXY</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go env -w GO111MODULE&#x3D;on</span><br><span class="line">go env -w GOPROXY&#x3D;https:&#x2F;&#x2F;goproxy.cn,direct</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/12/%E8%A7%A3%E5%86%B3go%E4%BE%9D%E8%B5%96%E5%8C%85%E8%A2%AB%E5%A2%99/" data-id="ckdr4gya00002bcuj54prf3vw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/" rel="tag">go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-后端耗时任务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/07/%E5%90%8E%E7%AB%AF%E8%80%97%E6%97%B6%E4%BB%BB%E5%8A%A1/" class="article-date">
  <time datetime="2020-08-07T01:35:27.000Z" itemprop="datePublished">2020-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/07/%E5%90%8E%E7%AB%AF%E8%80%97%E6%97%B6%E4%BB%BB%E5%8A%A1/">后端耗时操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>在前后端交互中，如果后端进行了很耗时的操作，前端迟迟收不到响应就会报错。</p>
<h2 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h2><p>目前我想到了两种方法：<br>1.提前处理， 2.异步处理。</p>
<h2 id="提前处理"><a href="#提前处理" class="headerlink" title="提前处理"></a>提前处理</h2><p>适用于数据变化频率不高的场景。比如一天一变，可以在前一天晚上处理好数据，然后再查询处理好的数据。这样响应速度就会大大提高。</p>
<h2 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h2><p>直接返回并将耗时任务放到后台。这里可以使用celery以及concurrent.futures。大型项目的话使用celery会好一点。<br>下面是concurrent.futures的简单使用</p>
<h2 id="警示"><a href="#警示" class="headerlink" title="警示"></a>警示</h2><p>在使用executor.submit时，不能把current_app当作参数传递，因为上下文的结束周是请求结束后。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">from flask import jsonify, app</span><br><span class="line">from concurrent.futures import ThreadPoolExecutor,  ProcessPoolExecutor</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">executor &#x3D; ThreadPoolExecutor(3)  # 线程池大小</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def func_task(subject, sender, recipients, app):</span><br><span class="line">    print(&#39;start&#39;)</span><br><span class="line">    msg &#x3D; Message(subject&#x3D;subject, sender&#x3D;sender, recipients&#x3D;recipients)</span><br><span class="line">    msg.body &#x3D; &#39;hello&#39;</span><br><span class="line">    with app.app_context():</span><br><span class="line">      mail.send(msg)</span><br><span class="line">    print(&#39;end&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;task&#x2F;&#39;)</span><br><span class="line">def send_mail():</span><br><span class="line">    subject &#x3D; current_app.config[&#39;FLASKY_MAIL_SUBJECT_PREFIX&#39;]</span><br><span class="line">    sender &#x3D; current_app.config[&#39;MAIL_DEFAULT_SENDER&#39;]</span><br><span class="line">    recipients &#x3D; current_app.config[&#39;FLASKY_MAIL_TO&#39;]</span><br><span class="line">    app &#x3D; current_app._get_current_object()</span><br><span class="line">    executor.submit(func_task, subject, sender, recipients, app)</span><br><span class="line">    return jsonify(&#123;&#39;code&#39;: 200, &#39;msg&#39;: &#39;success&#39;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">task_list &#x3D; [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def map_task(item):</span><br><span class="line">    time.sleep(10)</span><br><span class="line">    print(item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;task_map&#x2F;&#39;)</span><br><span class="line">def task_map():</span><br><span class="line">    executor.map(map_task, task_list)   # map 操作线程池</span><br><span class="line">    return jsonify(&#123;&#39;code&#39;: 200, &#39;msg&#39;: &#39;success&#39;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;task_wait&#x2F;&#39;)</span><br><span class="line">def task_wait():</span><br><span class="line">    f_list &#x3D; []</span><br><span class="line">    for _ in task_list:</span><br><span class="line">        future &#x3D; executor.submit(map_task, _)</span><br><span class="line">        f_list.append(future)</span><br><span class="line">    return jsonify(&#123;&#39;code&#39;: 200, &#39;data&#39;: wait(f_list)&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    app.run(&#39;0.0.0.0&#39;)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/07/%E5%90%8E%E7%AB%AF%E8%80%97%E6%97%B6%E4%BB%BB%E5%8A%A1/" data-id="ckdr4gya10003bcujegqy978h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrent-future/" rel="tag">concurrent.future</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql-bin文件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/06/mysql-bin%E6%96%87%E4%BB%B6/" class="article-date">
  <time datetime="2020-08-06T03:21:53.000Z" itemprop="datePublished">2020-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/06/mysql-bin%E6%96%87%E4%BB%B6/">mysql-bin文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="mysql-log文件里的mysql-bin文件"><a href="#mysql-log文件里的mysql-bin文件" class="headerlink" title="mysql log文件里的mysql-bin文件"></a>mysql log文件里的mysql-bin文件</h2><p>mysql-bin是mysql用来构建复制时候用的文件，如果不做’主从复制’的话，可以删除掉它，但是使用rm删除会不安全，若以可以通过mysql的命令去删除。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">reset master;</span><br></pre></td></tr></table></figure>
<p>或者更改配置文件,加入如下几句话，设定日志文件保留的天数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log-bin&#x3D;mysql-bin</span><br><span class="line">expire_logs_days &#x3D; 7</span><br></pre></td></tr></table></figure>
<h2 id="引入概念主从复制"><a href="#引入概念主从复制" class="headerlink" title="引入概念主从复制"></a>引入概念主从复制</h2><p>mysql 为什么要做主从复制（读写分离）？主要是为了性能考虑</p>
<h3 id="区分集群"><a href="#区分集群" class="headerlink" title="区分集群"></a>区分集群</h3><p>集群是由多台数据库服务器组成，数据写入和查询是在随机的一台机子进行的，其他数据库服务器会自动同步数据库操作。</p>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>主从复制有两种方式：基于日志（binlog）；基于GTID（全局事务标示符）。</p>
<h2 id="总表分表构建"><a href="#总表分表构建" class="headerlink" title="总表分表构建"></a>总表分表构建</h2><p>总表查询，分表写入（总表和分表结构必须保持一致）<br>分表结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;b&#96; (</span><br><span class="line">  &#96;sys_id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;sys_time&#96; datetime DEFAULT NULL,</span><br><span class="line">  KEY &#96;roomid&#96; (&#96;roomId&#96;) USING HASH,</span><br><span class="line">  KEY &#96;sys_time&#96; (&#96;sys_time&#96;) USING HASH</span><br><span class="line">) ENGINE&#x3D;MyISAM AUTO_INCREMENT&#x3D;8149668 DEFAULT CHARSET&#x3D;utf8mb4;</span><br></pre></td></tr></table></figure>
<p>总表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;a&#96; (</span><br><span class="line">  &#96;sys_id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;sys_time&#96; datetime DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;sys_id&#96;),</span><br><span class="line">  KEY &#96;sys_time&#96; (&#96;sys_time&#96;) USING HASH</span><br><span class="line">) ENGINE&#x3D;MRG_MyISAM DEFAULT CHARSET&#x3D;utf8mb4 UNION&#x3D;(&#96;b&#96;,&#96;c&#96;,&#96;d&#96;);</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/06/mysql-bin%E6%96%87%E4%BB%B6/" data-id="ckdr4gy8l0000bcujgadpdlef" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-flask-nginx-uwgi-supervisor部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/30/flask-nginx-uwgi-supervisor%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-07-30T01:30:21.000Z" itemprop="datePublished">2020-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/30/flask-nginx-uwgi-supervisor%E9%83%A8%E7%BD%B2/">flask+nginx+uWSGI+supervisor部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-安装python"><a href="#1-安装python" class="headerlink" title="1.安装python"></a>1.安装python</h2><p>安装wget</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget</span><br></pre></td></tr></table></figure>
<p>下载python包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;www.python.org&#x2F;ftp&#x2F;python&#x2F;3.8.2&#x2F;Python-3.8.2.tgz</span><br></pre></td></tr></table></figure>
<p>解压python到project目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf Python-3.8.2.tgz -C &#x2F;project&#x2F;</span><br></pre></td></tr></table></figure>
<p>编译时出错zipimport.ZipImportError: can’t decompress data; zlib not available</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install zlib* -y    # 缺少zlib包，安装zlib包</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;root&#x2F;Python3.8.2</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>创建软链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;project&#x2F;Python-3.8.2&#x2F;bin&#x2F;python3.8 &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">ln -s &#x2F;project&#x2F;Python-3.8.2&#x2F;bin&#x2F;pip3.8 &#x2F;usr&#x2F;bin&#x2F;pip3</span><br></pre></td></tr></table></figure>
<h2 id="centos安装mysql"><a href="#centos安装mysql" class="headerlink" title="centos安装mysql"></a>centos安装mysql</h2><p>1.下载mysql包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;MySQL-5.7&#x2F;mysql-5.7.32-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
<p>2.解压包到/usr/local/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql-5.7.32-linux-glibc2.12-x86_64.tar.gz -C &#x2F;usr&#x2F;local&#x2F;</span><br></pre></td></tr></table></figure>
<p>3.改文件名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">mv mysql-5.7.32-linux-glibc2.12-x86_64  mysql</span><br></pre></td></tr></table></figure>
<p>4.添加mysql用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd mysql&#x2F;</span><br><span class="line">useradd -s &#x2F;bin&#x2F;false -M mysql</span><br><span class="line">cd ..</span><br><span class="line">chown -R mysql:mysql mysql</span><br></pre></td></tr></table></figure>
<p>5.创建cnf文件，mysql-bin.log文件,mysql-error.log文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">touch &#x2F;etc&#x2F;my.cnf</span><br><span class="line">mkdir &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;logs</span><br><span class="line">touch &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;logs&#x2F;mysql-bin.log</span><br><span class="line">touch &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;mysql-error.log</span><br></pre></td></tr></table></figure>
<p>6.修改mysql目录权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;</span><br><span class="line">chown -R mysql:mysql mysql</span><br></pre></td></tr></table></figure>
<p>7.初始化数据库,并记录最后的数据库密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin</span><br><span class="line">.&#x2F;mysqld --initialize --user&#x3D;mysql --basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql --datadir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data</span><br></pre></td></tr></table></figure>
<p>将 mysql 加入服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files&#x2F;mysql.server  &#x2F;etc&#x2F;init.d&#x2F;mysql</span><br></pre></td></tr></table></figure>
<p>8.配置mysql，/etc/my.cnf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"># binlog 配置</span><br><span class="line">log-bin&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;logs&#x2F;mysql-bin.log</span><br><span class="line">expire-logs-days&#x3D;14</span><br><span class="line">max-binlog-size&#x3D;500M</span><br><span class="line">server-id&#x3D;1</span><br><span class="line"># GENERAL</span><br><span class="line">basedir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql</span><br><span class="line">datadir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data</span><br><span class="line">socket&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">user&#x3D;mysql</span><br><span class="line">default-storage-engine&#x3D;InnoDB</span><br><span class="line">character-set-server&#x3D;utf8</span><br><span class="line">lower_case_table_names &#x3D; 0  # 为0时，数据库名可以大写</span><br><span class="line">explicit_defaults_for_timestamp&#x3D;true</span><br><span class="line">sql_mode &#x3D;&#39;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#39;</span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;mysql-error.log</span><br><span class="line">pid-file&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;mysqld.pid</span><br><span class="line">[client]</span><br><span class="line">socket&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set&#x3D;utf8</span><br><span class="line">socket&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;mysql.sock</span><br></pre></td></tr></table></figure>
<p>9.开启mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 初次开启可以使用这个命令，方便查错</span><br><span class="line"># cd &#x2F;usr&#x2F;loacl&#x2F;mysql&#x2F;support-files&#x2F;</span><br><span class="line"># .&#x2F;mysql.server start</span><br><span class="line"># 如果提示Permission denied， 则使用下面方式启动</span><br><span class="line">service mysql start</span><br><span class="line">service mysql stop</span><br></pre></td></tr></table></figure>
<p>Failed to start mysql.service: Unit mysql.service not found.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mysql.service</span><br></pre></td></tr></table></figure>
<p>多次未能启动mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">卸载重装</span><br></pre></td></tr></table></figure>
<p>10.进入mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin</span><br><span class="line"> .&#x2F;mysql -u root -p</span><br></pre></td></tr></table></figure>
<p>修改密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;123456&#39;;</span><br><span class="line">CREATE USER &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;</span><br><span class="line">GRANT ALL PRIVILEGES ON  *.* TO &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39; WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><p>tengine是一个由淘宝从Nginx复刻出来的HTTP服务器.<br>nginx是高性能的http和反向代理的web服务器，仅仅支持静态网页，对于支持动态网页就会显得无能为力，在处理并发上较强。<br>1.安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc-c++</span><br><span class="line">yum install -y pcre pcre-devel</span><br><span class="line">yum install -y zlib zlib-devel</span><br><span class="line">yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>
<p>2.下载包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>
<p>3.解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.18.0.tar.gz</span><br><span class="line">cd nginx-1.18.0</span><br></pre></td></tr></table></figure>
<p>4.配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --with-http_ssl_module  # 安装http_ssl_module</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure   # 默认配置</span><br></pre></td></tr></table></figure>
<p>如果开始时没有安装ssl模块支持，后续需要添加时：<br>进入源码文件下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root&#x2F;nginx-1.16.0</span><br></pre></td></tr></table></figure>
<p>查看nginx已安装模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx --with-http_stub_status_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>
<p>备份替换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx.bak</span><br></pre></td></tr></table></figure>
<p>编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
<p>停止nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkill -9 nginx</span><br></pre></td></tr></table></figure>
<p>覆盖掉原有的nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp .&#x2F;objs&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br></pre></td></tr></table></figure>
<p>查看nginx已安装模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -V</span><br></pre></td></tr></table></figure>
<p>5.编译并安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>6.查找安装路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whereis nginx</span><br></pre></td></tr></table></figure>
<p>7.启动，停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;</span><br><span class="line">.&#x2F;nginx</span><br><span class="line">.&#x2F;nginx -s stop</span><br><span class="line">.&#x2F;nginx -s quit</span><br><span class="line">.&#x2F;nginx -s reload</span><br></pre></td></tr></table></figure>
<h2 id="导入web应用"><a href="#导入web应用" class="headerlink" title="导入web应用"></a>导入web应用</h2><p>略</p>
<h2 id="安装uWSGI"><a href="#安装uWSGI" class="headerlink" title="安装uWSGI"></a>安装uWSGI</h2><p>uWSGI是一个Web服务器，Nginx中HttpUwsgiModule的作用是与uWSGI服务器进行交换</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">socket &#x3D; 127.0.0.1:8081</span><br><span class="line">chdir&#x3D; &#x2F;code&#x2F;ClashRoyale  # 项目名</span><br><span class="line">wsgi_file&#x3D;server.py       # app启动文件</span><br><span class="line">callable &#x3D; app</span><br><span class="line">master &#x3D; true</span><br><span class="line">vacuum &#x3D; true</span><br><span class="line">chmod-socket&#x3D;664</span><br><span class="line">stats&#x3D;0.0.0.0:9191</span><br><span class="line">listen&#x3D;128</span><br><span class="line">processes&#x3D;5</span><br><span class="line">thunder-lock&#x3D;true</span><br><span class="line">harakiri&#x3D;90</span><br><span class="line">daemonize&#x3D; &#x2F;code&#x2F;ClashRoyale&#x2F;log&#x2F;uwsgi.log</span><br><span class="line">pidfile&#x3D; &#x2F;code&#x2F;ClashRoyale&#x2F;uwsgi.pid</span><br></pre></td></tr></table></figure>
<p>wsgi<br>全称Python Web Server Gateway Interface，指定了web服务器和Python web应用或web框架之间的标准接口，以提高web应用在一系列web服务器间的移植性。<br>1.WSGI是一套接口标准协议/规范；<br>2.通信（作用）区间是Web服务器和Python Web应用程序之间；<br>3.目的是制定标准，以保证不同Web服务器可以和不同的Python程序之间相互通信<br>uwsgi<br>uwsgi协议是一个uWSGI服务器自有的协议</p>
<h2 id="Gunicorn"><a href="#Gunicorn" class="headerlink" title="Gunicorn"></a>Gunicorn</h2><p>高并发下的选择。这是一个被广泛使用的高性能的Python WSGI UNIX HTTP服务器,也有人选择uWsgi可以达到同样的效果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install gunicorn</span><br></pre></td></tr></table></figure>
<h2 id="web应用处理请求整体流程"><a href="#web应用处理请求整体流程" class="headerlink" title="web应用处理请求整体流程"></a>web应用处理请求整体流程</h2><p>1.用户操作浏览器发送请求<br>2.请求转发到对应的web服务器（nginx）,一般来说如果是静态请求，直接返回静态页面（纯HTML页面）,nginx反向代理到uWSGI web应用服务器<br>3.web服务器将请求转交给web应用程序，web应用程序处理请求<br>4.web应用将请求结果返回给web服务器，由web服务器返回用户响应结果<br>5.浏览器收到响应，向用户展示<br>为什么有了uWSGI为什么还需要nginx？因为nginx具备优秀的静态内容处理能力，然后将动态内容转发给uWSGI服务器，这样可以达到很好的客户端响应。</p>
<h2 id="服务器结构图"><a href="#服务器结构图" class="headerlink" title="服务器结构图"></a>服务器结构图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   web 框架（Flask）</span><br><span class="line">     ||</span><br><span class="line">	 ||</span><br><span class="line">   WSGI容器</span><br><span class="line"> （uWSGI应用服务器）</span><br><span class="line">     ||</span><br><span class="line">	 ||</span><br><span class="line">   web服务器</span><br><span class="line">（NGINX，http服务器）</span><br><span class="line">     ||</span><br><span class="line">   客户端</span><br></pre></td></tr></table></figure>
<h2 id="静态网页和动态网页区别"><a href="#静态网页和动态网页区别" class="headerlink" title="静态网页和动态网页区别"></a>静态网页和动态网页区别</h2><p>静态网页是写死的，所有的内容都是不变的，除非修改静态网页代码；<br>动态网页是通过数据库动态的生成网页的。</p>
<h2 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h2><p>Tomcat，web应用服务器（可以看作一个WEB容器，但实际上是一个应用程序服务器）（区别于Nginx的web服务器）既能为动态网页服务，又能为静态网页提供支持。单Tomcat没有通常的Web服务器快，所以大型网站可以选择Tomcat和Nginx结合，Nginx负责接受客户端的http请求，然后将请求抓发给Tomcat来处理。</p>
<h2 id="安装supervisor"><a href="#安装supervisor" class="headerlink" title="安装supervisor"></a>安装supervisor</h2><p>1.下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install supervisor</span><br></pre></td></tr></table></figure>
<p>2.修改配置文件(/etc/supervisord.conf)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[inet_http_server]         ; inet (TCP) server disabled by default</span><br><span class="line">port&#x3D;0.0.0.0:9001        ; (ip_address:port specifier, *:port for all iface)</span><br><span class="line">username&#x3D;user              ; (default is no username (open server))</span><br><span class="line">password&#x3D;123               ; (default is no password (open server))</span><br><span class="line">...</span><br><span class="line">[include]</span><br><span class="line">files &#x3D; &#x2F;etc&#x2F;supervisord.d&#x2F;*.conf</span><br></pre></td></tr></table></figure>
<p>3.各服务配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># directory &#x3D; &#x2F;Code&#x2F;project        程序的启动目录  </span><br><span class="line"># command &#x3D; gunicorn -w 4 -worker-class gevent -bind 0.0.0.0:5000 入口文件名:app   启动命令</span><br><span class="line">[program:CR_data_server]</span><br><span class="line">command&#x3D;uwsgi --ini &#x2F;code&#x2F;ClashRoyale&#x2F;conf&#x2F;uwsgi.ini</span><br><span class="line">autostart&#x3D;true</span><br><span class="line">autorestart&#x3D;true</span><br><span class="line">stdout_logfile&#x3D;&#x2F;code&#x2F;ClashRoyale&#x2F;log&#x2F;uwsgi_supervisor.log</span><br><span class="line">daemonize&#x3D;no</span><br><span class="line">user&#x3D;root</span><br></pre></td></tr></table></figure>
<p>4.问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl reread</span><br><span class="line">error: &lt;class &#39;ConnectionRefusedError&#39;&gt;, [Errno 111] Connection refused: file: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;supervisor&#x2F;xmlrpc.py line: 560</span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep supervisor</span><br><span class="line">kill -9 id</span><br><span class="line">supervisord</span><br><span class="line">supervisorctl reload</span><br></pre></td></tr></table></figure>
<h2 id="单一部署"><a href="#单一部署" class="headerlink" title="单一部署"></a>单一部署</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class="line"></span><br><span class="line">    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;</span><br><span class="line">    default_type        application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	charset utf-8;</span><br><span class="line"></span><br><span class="line">	location &#x2F; &#123;</span><br><span class="line">		include uwsgi_params;</span><br><span class="line">		uwsgi_pass 127.0.0.1:8081;</span><br><span class="line">		uwsgi_param UWSGI_CHDIR &#x2F;code&#x2F;ClashRoyale;  # 项目根目录</span><br><span class="line">		uwsgi_param UWSGI_SCRIPT server:app;        # server 为app入口name</span><br><span class="line">		uwsgi_read_timeout 300;</span><br><span class="line">		uwsgi_connect_timeout 300;</span><br><span class="line">        uwsgi_send_timeout 300;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="前后端分离部署"><a href="#前后端分离部署" class="headerlink" title="前后端分离部署"></a>前后端分离部署</h2><p>nginx配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name xxxx.com www.xxxx.com;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">      root &#x2F;root&#x2F;works_app&#x2F;dist; # 生成的静态文件的地址</span><br><span class="line">      index index.html index.htm;</span><br><span class="line">      try_files $uri $uri&#x2F; &#x2F;index.html;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    location &#x2F;api &#123;</span><br><span class="line">	   	  proxy_pass http:&#x2F;&#x2F;127.0.0.1:81;     # 反向代理到后端</span><br><span class="line">	      proxy_set_header Host $host;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81;</span><br><span class="line">    server_name xxxx.com;  # 域名，更换成自己的域名</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">      include uwsgi_params;</span><br><span class="line">      uwsgi_pass 127.0.0.1:8081;</span><br><span class="line">      uwsgi_param UWSGI_CHDIR &#x2F;code&#x2F;DataPortal;</span><br><span class="line">      uwsgi_param UWSGI_SCRIPT manage:app;</span><br><span class="line">      uwsgi_param UWSGI_SCRIPT manage:app;</span><br><span class="line">      uwsgi_read_timeout 300;</span><br><span class="line">      uwsgi_connect_timeout 300;</span><br><span class="line">      uwsgi_send_timeout 300;</span><br><span class="line">    	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后重启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/30/flask-nginx-uwgi-supervisor%E9%83%A8%E7%BD%B2/" data-id="ckddufv2x00012suj0uwkb9yk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%83%A8%E7%BD%B2/" rel="tag">部署</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%90%AD%E5%BB%BA/">搭建</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MessageQueue/" rel="tag">MessageQueue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cProfile/" rel="tag">cProfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/celery/" rel="tag">celery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos/" rel="tag">centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concurrent-future/" rel="tag">concurrent.future</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/" rel="tag">database</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dict/" rel="tag">dict</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/domain/" rel="tag">domain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es/" rel="tag">es</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http-status-code/" rel="tag">http status code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logstash/" rel="tag">logstash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/" rel="tag">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/navicat/" rel="tag">navicat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nosql/" rel="tag">nosql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oauth/" rel="tag">oauth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlalchemy/" rel="tag">sqlalchemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uwsgi/" rel="tag">uwsgi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v2ay/" rel="tag">v2ay</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yapi/" rel="tag">yapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E8%A1%8C/" rel="tag">并行</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%83%A8%E7%BD%B2/" rel="tag">部署</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MessageQueue/" style="font-size: 10px;">MessageQueue</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/RabbitMQ/" style="font-size: 10px;">RabbitMQ</a> <a href="/tags/cProfile/" style="font-size: 10px;">cProfile</a> <a href="/tags/celery/" style="font-size: 11.67px;">celery</a> <a href="/tags/centos/" style="font-size: 10px;">centos</a> <a href="/tags/concurrent-future/" style="font-size: 10px;">concurrent.future</a> <a href="/tags/database/" style="font-size: 11.67px;">database</a> <a href="/tags/dict/" style="font-size: 10px;">dict</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/domain/" style="font-size: 10px;">domain</a> <a href="/tags/es/" style="font-size: 11.67px;">es</a> <a href="/tags/flask/" style="font-size: 16.67px;">flask</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/http-status-code/" style="font-size: 10px;">http status code</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/logstash/" style="font-size: 10px;">logstash</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/mysql/" style="font-size: 18.33px;">mysql</a> <a href="/tags/navicat/" style="font-size: 10px;">navicat</a> <a href="/tags/nginx/" style="font-size: 13.33px;">nginx</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/oauth/" style="font-size: 10px;">oauth</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/redis/" style="font-size: 11.67px;">redis</a> <a href="/tags/sqlalchemy/" style="font-size: 15px;">sqlalchemy</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/uwsgi/" style="font-size: 10px;">uwsgi</a> <a href="/tags/v2ay/" style="font-size: 10px;">v2ay</a> <a href="/tags/yapi/" style="font-size: 10px;">yapi</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%B9%B6%E8%A1%8C/" style="font-size: 10px;">并行</a> <a href="/tags/%E9%83%A8%E7%BD%B2/" style="font-size: 10px;">部署</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/12/18/%E5%9F%9F%E5%90%8D/">域名</a>
          </li>
        
          <li>
            <a href="/2020/12/03/sqlalchemy%E4%B8%80%E6%AC%A1%E9%94%81%E8%A1%A8/">sqlalchemy一次锁表</a>
          </li>
        
          <li>
            <a href="/2020/11/23/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A8%AA%E7%AB%96%E8%A1%A8/">数据库横竖表</a>
          </li>
        
          <li>
            <a href="/2020/11/20/logstash%E5%AE%89%E8%A3%85/">logstash安装</a>
          </li>
        
          <li>
            <a href="/2020/11/19/python%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">python性能调优</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>